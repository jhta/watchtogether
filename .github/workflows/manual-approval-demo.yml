name: Manual Approval Demo

on:
  # Trigger on manual dispatch for testing
  workflow_dispatch:
    inputs:
      message:
        description: "Message to log after approval"
        required: false
        default: "Hello from approved workflow!"

  # Also trigger on push to main branch
  push:
    branches: [main]

jobs:
  request-approval:
    runs-on: ubuntu-latest

    # Set permissions for the action to create issues
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Request Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.actor }} # Uses the person who triggered the workflow as approver
          minimum-approvals: 1
          issue-title: "Manual Approval Required: ${{ github.workflow }}"
          issue-body: |
            ## Approval Request

            **Workflow:** ${{ github.workflow }}
            **Triggered by:** ${{ github.actor }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}

            **Action:** This workflow will execute a console log after approval.

            **Message to log:** ${{ github.event.inputs.message || 'Hello from approved workflow!' }}

            ---

            Please review and approve this workflow execution by commenting:
            - `approve` or `approved` or `lgtm` or `yes` to approve
            - `deny` or `denied` or `no` to reject
          exclude-workflow-initiator-as-approver: false
          fail-on-denial: true

      - name: Create Success Message File
        run: |
          # Create a temporary file with success information
          mkdir -p /tmp/workflow-data
          cat > /tmp/workflow-data/success-message.txt << EOF
          🎉 Workflow approved successfully!
          📝 Message: ${{ github.event.inputs.message || 'Hello from approved workflow!' }}
          👤 Approved by workflow initiator: ${{ github.actor }}
          🌟 Timestamp: $(date)
          🔗 Repository: ${{ github.repository }}
          🎯 Branch: ${{ github.ref_name }}
          🆔 Workflow Run ID: ${{ github.run_id }}
          🔢 Workflow Run Number: ${{ github.run_number }}
          EOF

          echo "✅ Success message file created at /tmp/workflow-data/success-message.txt"
          echo "📂 File size: $(wc -c < /tmp/workflow-data/success-message.txt) bytes"

      - name: Read and Display Success Message
        run: |
          echo "📖 Reading success message from temporary file..."
          echo "==================== SUCCESS MESSAGE ===================="
          cat /tmp/workflow-data/success-message.txt
          echo "========================================================"
          echo ""
          echo "✅ This demonstrates how to pass data between workflow steps using files"
          echo "🔐 This pattern can be used for secrets, configuration, or any data sharing"

      - name: Additional Operations Step
        run: |
          echo "🚀 This is where you could add deployment or critical operations"
          echo "📄 We have access to the success message file for any additional processing"
          echo ""
          echo "📊 File contents summary:"
          echo "- Lines: $(wc -l < /tmp/workflow-data/success-message.txt)"
          echo "- Words: $(wc -w < /tmp/workflow-data/success-message.txt)"
          echo "- Characters: $(wc -c < /tmp/workflow-data/success-message.txt)"

      - name: Cleanup Temporary Files
        run: |
          echo "🧹 Cleaning up temporary files..."
          rm -rf /tmp/workflow-data
          echo "✅ Temporary files removed"
